<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domain-Specific ASR – Audio Submission</title>

<style>
/* ===== Base ===== */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width: 1000px;
  margin: 40px auto;
  padding: 0 16px;
  line-height: 1.5;
  background: #0f172a;
  color: #f1f5f9;
}
h1, h2, h3 { margin-top: 0; }
.small { color: #94a3b8; font-size: 0.95rem; }
code { background: #334155; padding: 2px 6px; border-radius: 8px; color: #f8fafc; }

/* ===== Top Challenges Image ===== */
.challenges img {
  width: 100%;
  border-radius: 14px;
  border: 1px solid #334155;
  display: block;
}
.image-credit {
  text-align: right;
  font-size: 0.85rem;
  color: #94a3b8;
  margin-top: 6px;
  font-style: italic;
}

/* ===== Demo Table ===== */
.demo-table-wrapper { overflow-x: auto; margin-top: 20px; }
.demo-table {
  width: 100%;
  border-collapse: collapse;
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 12px;
  overflow: hidden;
}
.demo-table th, .demo-table td {
  padding: 14px;
  text-align: left;
  border-bottom: 1px solid #334155;
  vertical-align: middle;
}
.demo-table th { background: #0f172a; color: #f8fafc; font-weight: 600; }
.demo-table tr:hover { background: #273449; }
.demo-table audio { width: 180px; }

/* ===== Cards ===== */
.card {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 14px;
  padding: 18px;
}

/* ===== Buttons ===== */
.btn {
  display: inline-block;
  padding: 12px 16px;
  border-radius: 12px;
  text-decoration: none;
  border: 1px solid #475569;
  background: #1e293b;
  color: #f1f5f9;
  transition: all 0.2s ease;
  cursor: pointer;
}
.btn:hover { background: #334155; }
.btn.primary {
  background: #2563eb;
  border: 1px solid #2563eb;
  color: white;
}
.btn.primary:hover { background: #1d4ed8; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* ===== Form Fields ===== */
label { display: block; margin-top: 12px; font-weight: 600; }
input, select {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #334155;
  margin-top: 6px;
  background: #0f172a;
  color: #f1f5f9;
}
input::placeholder { color: #94a3b8; }

/* ===== Contribute Layout (Sticky Image + Form) ===== */
.contribute-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 30px;
  margin: 40px auto;
  max-width: 1200px;
}
@media (min-width: 980px) {
  .contribute-grid { grid-template-columns: 1fr 1.4fr; align-items: start; }
}

.req-sticky {
  background: #f8fafc;
  border: 1px solid #334155;
  border-radius: 14px;
  padding: 14px;
  color: #0f172a;
}
.req-sticky img { width: 100%; border-radius: 12px; display: block; }
.req-sticky .image-credit { color: #475569; }

@media (min-width: 980px) {
  .req-sticky { position: sticky; top: 20px; }
  .req-sticky img { height: 700px; object-fit: contain; }
}

.form-stack .card { margin-bottom: 16px; }

.sentence-group { position: relative; margin-bottom: 12px; }
.remove-btn {
  position: absolute;
  right: 10px;
  top: 60%;
  background: #ef4444;
  border: none;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  cursor: pointer;
  font-size: 14px;
  line-height: 20px;
  padding: 0;
}
.remove-btn:hover { background: #dc2626; }
</style>
</head>

<body>

<!-- ===== Top Image ===== -->
<section class="challenges">
  <img src="assets/images/asr_challenges.png"
       alt="Domain-aware ASR challenges: lab noise and terminology">
  <p class="image-credit">AI-generated illustration (OpenAI)</p>
</section>

<!-- ===== Demo Section ===== -->
<section>
  <h2>Model Demos</h2>
  <div class="demo-table-wrapper">
    <table class="demo-table">
      <thead>
        <tr><th>Description</th><th>Transcription</th><th>Audio</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Office noise (no speech)</td>
          <td>Keyboard clicks and ventilation background.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo1.wav" type="audio/wav"></audio></td>
        </tr>
        <tr>
          <td>Street ambience</td>
          <td>Background traffic and bicycle bell.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo2.wav" type="audio/wav"></audio></td>
        </tr>
        <tr>
          <td>Cafeteria ambience</td>
          <td>Dishes clinking and crowd murmur.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo3.wav" type="audio/wav"></audio></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ===== Contribution Section ===== -->
<h1>Contribute to the Dataset</h1>
<p class="small">
Fill in your details, optionally download your metadata CSV for your records, then upload your audio below.
</p>

<section class="contribute-grid">

  <!-- Sticky Image -->
  <aside class="req-sticky">
    <img src="assets/images/domain_asr_requirements_new.png"
         alt="We need lab-noise audio and example lab sentences">
    <p class="image-credit">AI-generated illustration (OpenAI)</p>
  </aside>

  <!-- Form + Upload -->
  <div class="form-stack">

    <div class="card">
      <h2>Step 1 — Your Details</h2>

      <label for="email">Email</label>
      <input id="email" type="email" required>

      <label for="occupation">Occupation</label>
      <select id="occupation" required>
        <option value="" disabled selected>Select your occupation</option>
        <option value="phd_student">PhD Student</option>
        <option value="postdoc">Postdoc</option>
        <option value="professor">Professor</option>
        <option value="engineer">Engineer</option>
        <option value="industry_researcher">Industry Researcher</option>
        <option value="other">Other</option>
      </select>

      <label for="university">University / Organization</label>
      <input id="university" type="text" required>

      <h3>Example Sentences</h3>
      <div id="sentenceContainer">
        <div class="sentence-group">
          <label>Sentence 1</label>
          <input type="text" class="sentence-input">
        </div>
      </div>

      <button type="button" class="btn" id="addSentenceBtn" style="margin-top:10px;">
        + Add another sentence
      </button>

      <label for="consent">Consent</label>
      <select id="consent" required>
        <option value="">Select…</option>
        <option value="yes">I consent to using my audio for this project.</option>
        <option value="no">I do not consent</option>
      </select>

      <p class="small">
        Your submission ID: <code id="sid">—</code><br>
        (You can upload up to 10 files. We store them under this submission ID.)
      </p>

      <button class="btn" id="downloadBtn" type="button">
        Download metadata (.csv)
      </button>
    </div>

    <div class="card">
      <h2>Step 2 — Upload Audio</h2>

      <label for="audioFiles">Upload up to 10 files (.wav, .mp3, .m4a), total ≤ 5 MB</label>
      <input id="audioFiles" type="file" multiple accept=".wav,.mp3,.m4a,audio/*" required>

      <p class="small" id="sizeHint" style="margin-top:8px;"></p>

      <button class="btn primary" id="uploadBtn" type="button" style="margin-top:12px;">
        Upload audio + submit metadata
      </button>

      <p class="small" id="uploadStatus" style="margin-top:10px;"></p>
    </div>

  </div>
</section>

<script>
/* ===== API endpoints ===== */
const API_BASE = "https://71z3aqiv16.execute-api.us-east-1.amazonaws.com";
const PRESIGN_ENDPOINT = API_BASE + "/presign";
const SUBMIT_ENDPOINT  = API_BASE + "/submit";

/* ===== Limits ===== */
const MAX_FILES = 10;
const MAX_TOTAL_BYTES = 5 * 1024 * 1024; // 5 MB total
const ALLOWED_EXT = new Set(["wav","mp3","m4a"]);

/* ===== Helpers ===== */
function makeId() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const rand = Math.random().toString(16).slice(2,8).toUpperCase();
  return `FAU-${y}${m}${day}-${rand}`;
}

function csvEsc(v){
  return `"${String(v ?? "").replaceAll('"','""')}"`;
}

function bytesToMB(b){ return (b / (1024*1024)).toFixed(2); }

/* ===== Submission ID ===== */
const sid = makeId();
document.getElementById("sid").textContent = sid;

/* ===== Download metadata (local CSV) ===== */
document.getElementById("downloadBtn").addEventListener("click", () => {
  const email = document.getElementById("email").value.trim();
  const occupation = document.getElementById("occupation").value;
  const university = document.getElementById("university").value.trim();
  const consent = document.getElementById("consent").value;

  if (!email || !occupation || !university || consent !== "yes") {
    alert("Please complete all required fields and consent.");
    return;
  }

  const sentenceInputs = document.querySelectorAll(".sentence-input");
  const sentences = [];
  sentenceInputs.forEach(input => sentences.push(csvEsc(input.value.trim())));

  const headerBase = ["submission_id","email","occupation","university","consent"];
  const sentenceHeaders = sentences.map((_, i) => `sentence${i+1}`);
  const header = [...headerBase, ...sentenceHeaders, "timestamp"].join(",") + "\n";

  const row = [
    sid,
    csvEsc(email),
    csvEsc(occupation),
    csvEsc(university),
    "yes",
    ...sentences,
    new Date().toISOString()
  ].join(",") + "\n";

  const blob = new Blob([header + row], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = sid + ".csv";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
});

/* ===== Dynamic sentence fields ===== */
const container = document.getElementById("sentenceContainer");

function updateLabels() {
  const groups = container.querySelectorAll(".sentence-group");

  groups.forEach((group, index) => {
    const label = group.querySelector("label");
    label.textContent = "Sentence " + (index + 1);

    let removeBtn = group.querySelector(".remove-btn");
    if (index === 0) {
      if (removeBtn) removeBtn.remove();
    } else {
      if (!removeBtn) {
        removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "×";
        removeBtn.addEventListener("click", () => {
          group.remove();
          updateLabels();
        });
        group.appendChild(removeBtn);
      }
    }
  });
}

document.getElementById("addSentenceBtn").addEventListener("click", () => {
  const wrapper = document.createElement("div");
  wrapper.className = "sentence-group";

  const label = document.createElement("label");
  label.textContent = "Sentence";

  const input = document.createElement("input");
  input.type = "text";
  input.className = "sentence-input";

  wrapper.appendChild(label);
  wrapper.appendChild(input);
  container.appendChild(wrapper);

  updateLabels();
});

updateLabels();

/* ===== Collect form data ===== */
function collectFormDataOrAlert() {
  const email = document.getElementById("email").value.trim();
  const occupation = document.getElementById("occupation").value;
  const university = document.getElementById("university").value.trim();
  const consent = document.getElementById("consent").value;

  if (!email || !occupation || !university || consent !== "yes") {
    alert("Please complete all required fields and consent.");
    return null;
  }

  const sentenceInputs = document.querySelectorAll(".sentence-input");
  const sentences = [];
  sentenceInputs.forEach(input => {
    const v = input.value.trim();
    if (v) sentences.push(v);
  });

  return {
    submission_id: sid,
    email,
    occupation,
    university,
    consent,
    sentences,
    timestamp: new Date().toISOString()
  };
}

/* ===== Show selected total size ===== */
const audioInput = document.getElementById("audioFiles");
const sizeHint = document.getElementById("sizeHint");

audioInput.addEventListener("change", () => {
  const files = Array.from(audioInput.files || []);
  const total = files.reduce((s,f) => s + (f.size || 0), 0);
  sizeHint.textContent = files.length
    ? `Selected: ${files.length} file(s), total ${bytesToMB(total)} MB (limit 5.00 MB)`
    : "";
});

/* ===== Upload + submit ===== */
document.getElementById("uploadBtn").addEventListener("click", async () => {
  const status = document.getElementById("uploadStatus");
  const btn = document.getElementById("uploadBtn");

  status.textContent = "";
  const data = collectFormDataOrAlert();
  if (!data) return;

  const files = Array.from(audioInput.files || []);
  if (files.length === 0) { alert("Please select audio files."); return; }
  if (files.length > MAX_FILES) { alert("Max 10 files."); return; }

  const total = files.reduce((s,f) => s + (f.size || 0), 0);
  if (total > MAX_TOTAL_BYTES) { alert("Total size must be ≤ 5 MB."); return; }

  // file descriptors for backend presign
  let descriptors;
  try {
    descriptors = files.map(f => {
      const ext = (f.name.split(".").pop() || "").toLowerCase();
      if (!ALLOWED_EXT.has(ext)) throw new Error("Not allowed: " + f.name);
      return { ext, content_type: f.type || "application/octet-stream", size: f.size };
    });
  } catch (e) {
    alert(e.message || String(e));
    return;
  }

  btn.disabled = true;

  try {
    status.textContent = "Requesting upload permissions…";

    const r = await fetch(PRESIGN_ENDPOINT, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ submission_id: sid, files: descriptors })
    });

    if (!r.ok) throw new Error(await r.text());

    const { presigns } = await r.json();
    if (!Array.isArray(presigns) || presigns.length !== files.length) {
      throw new Error("Presign response mismatch.");
    }

    const audio_keys = [];

    for (let i = 0; i < files.length; i++) {
      status.textContent = `Uploading ${i+1}/${files.length}…`;

      const file = files[i];
      const { key, upload } = presigns[i];

      const fd = new FormData();
      Object.entries(upload.fields).forEach(([k,v]) => fd.append(k, v));
      fd.append("file", file);

      const up = await fetch(upload.url, { method: "POST", body: fd });
      if (!up.ok) throw new Error(`Upload failed for file ${i+1}`);

      audio_keys.push(key);
    }

    status.textContent = "Saving metadata…";

    const s = await fetch(SUBMIT_ENDPOINT, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ ...data, audio_keys })
    });

    if (!s.ok) throw new Error(await s.text());

    status.textContent = `Done ✅ Submission: ${sid}`;
  } catch (e) {
    console.error(e);
    status.textContent = "Failed ❌ " + (e?.message || e);
  } finally {
    btn.disabled = false;
  }
});
</script>

</body>
</html>
