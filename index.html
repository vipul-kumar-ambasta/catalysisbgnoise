<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domain-Specific ASR – Audio Submission</title>

<style>
/* ===== Base ===== */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  max-width: 1000px;
  margin: 40px auto;
  padding: 0 16px;
  line-height: 1.5;
  background: #0f172a;
  color: #f1f5f9;
}
h1, h2, h3 { margin-top: 0; }
.small { color: #94a3b8; font-size: 0.95rem; }
code { background: #334155; padding: 2px 6px; border-radius: 8px; color: #f8fafc; }

/* ===== Top Challenges Image ===== */
.challenges img {
  width: 100%;
  border-radius: 14px;
  border: 1px solid #334155;
  display: block;
}
.image-credit {
  text-align: right;
  font-size: 0.85rem;
  color: #94a3b8;
  margin-top: 6px;
  font-style: italic;
}

/* ===== Demo Table ===== */
.demo-table-wrapper { overflow-x: auto; margin-top: 20px; }
.demo-table {
  width: 100%;
  border-collapse: collapse;
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 12px;
  overflow: hidden;
}
.demo-table th, .demo-table td {
  padding: 14px;
  text-align: left;
  border-bottom: 1px solid #334155;
  vertical-align: middle;
}
.demo-table th { background: #0f172a; color: #f8fafc; font-weight: 600; }
.demo-table tr:hover { background: #273449; }
.demo-table audio { width: 180px; }

/* ===== Cards ===== */
.card {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 14px;
  padding: 18px;
}

/* ===== Buttons ===== */
.btn {
  display: inline-block;
  padding: 12px 16px;
  border-radius: 12px;
  text-decoration: none;
  border: 1px solid #475569;
  background: #1e293b;
  color: #f1f5f9;
  transition: all 0.2s ease;
  cursor: pointer;
}
.btn:hover { background: #334155; }
.btn.primary {
  background: #2563eb;
  border: 1px solid #2563eb;
  color: white;
}
.btn.primary:hover { background: #1d4ed8; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* ===== Form Fields ===== */
label { display: block; margin-top: 12px; font-weight: 600; }
input, select {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #334155;
  margin-top: 6px;
  background: #0f172a;
  color: #f1f5f9;
}
input::placeholder { color: #94a3b8; }

/* ===== Contribute Layout (Sticky Image + Form) ===== */
.contribute-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 30px;
  margin: 40px auto;
  max-width: 1200px;
}
@media (min-width: 980px) {
  .contribute-grid { grid-template-columns: 1fr 1.4fr; align-items: start; }
}

.req-sticky {
  background: #f8fafc;
  border: 1px solid #334155;
  border-radius: 14px;
  padding: 14px;
  color: #0f172a;
}
.req-sticky img { width: 100%; border-radius: 12px; display: block; }
.req-sticky .image-credit { color: #475569; }

@media (min-width: 980px) {
  .req-sticky { position: sticky; top: 20px; }
  .req-sticky img { height: 700px; object-fit: contain; }
}

.form-stack .card { margin-bottom: 16px; }

.sentence-group { position: relative; margin-bottom: 12px; }
.remove-btn {
  position: absolute;
  right: 10px;
  top: 60%;
  background: #ef4444;
  border: none;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  cursor: pointer;
  font-size: 14px;
  line-height: 20px;
  padding: 0;
}
.remove-btn:hover { background: #dc2626; }
</style>
</head>

<body>

<!-- ===== Top Image ===== -->
<section class="challenges">
  <img src="assets/images/asr_challenges.png"
       alt="Domain-aware ASR challenges: lab noise and terminology">
  <p class="image-credit">AI-generated illustration (OpenAI)</p>
</section>

<!-- ===== Demo Section ===== -->
<section>
  <h2>Model Demos</h2>
  <div class="demo-table-wrapper">
    <table class="demo-table">
      <thead>
        <tr><th>Description</th><th>Transcription</th><th>Audio</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Office noise (no speech)</td>
          <td>Keyboard clicks and ventilation background.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo1.wav" type="audio/wav"></audio></td>
        </tr>
        <tr>
          <td>Street ambience</td>
          <td>Background traffic and bicycle bell.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo2.wav" type="audio/wav"></audio></td>
        </tr>
        <tr>
          <td>Cafeteria ambience</td>
          <td>Dishes clinking and crowd murmur.</td>
          <td><audio controls preload="metadata"><source src="assets/audio/demo3.wav" type="audio/wav"></audio></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ===== Contribution Section ===== -->

<section class="contribute-grid">

  <!-- Sticky Image -->
  <aside class="req-sticky">
    <img src="assets/images/domain_asr_requirements_new.png"
         alt="We need lab-noise audio and example lab sentences">
    <p class="image-credit">AI-generated illustration (OpenAI)</p>
  </aside>

  <!-- Form + Upload -->
  <div class="form-stack">

    <div class="card">
      <h2>Step 1 — Your Details</h2>

      <label for="email">Email</label>
      <input id="email" type="email" required>

      <label for="occupation">Occupation</label>
      <select id="occupation" required>
        <option value="" disabled selected>Select your occupation</option>
        <option value="phd_student">PhD Student</option>
        <option value="postdoc">Postdoc</option>
        <option value="professor">Professor</option>
        <option value="engineer">Engineer</option>
        <option value="industry_researcher">Industry Researcher</option>
        <option value="other">Other</option>
      </select>

      <label for="university">University / Organization</label>
      <input id="university" type="text" required>

    </div>
    <div class='card'>
      <h2>Step 2 : Example sentences </h2>
      <div id="sentenceContainer">
        <div class="sentence-group">
          <label>Sentence 1</label>
          <input type="text" class="sentence-input">
        </div>
     </div>
    
    <button type="button" class="btn" id="addSentenceBtn" style="margin-top:10px;">
      + Add another sentence
    </button>
    </div>
    

    <div class="card">
      <h2>Step 3 — Upload Audio</h2>

      <label for="audioFiles">Upload up to 10 files (.wav, .mp3), total ≤ 10 MB</label>
      <input id="audioFiles" type="file" multiple accept=".wav,.mp3" required>

      <p class="small" id="sizeHint" style="margin-top:8px;"></p>

      <button class="btn primary" id="uploadBtn" type="button" style="margin-top:12px;">
        Upload audio + submit metadata
      </button>

      <p class="small" id="uploadStatus" style="margin-top:10px;"></p>
    </div>
    <div class="card" style="margin-top:12px; background:#0f172a; border:1px solid #334155;">
          <h3 style="margin:0 0 8px 0;">Data use & privacy notice</h3>
          <p class="small" style="margin:0;">
                By uploading, you agree that your <b>audio recordings</b> and <b>example sentences</b> may be used to
                train and evaluate speech recognition models for research purposes.
                Your recordings and sentences will <b>not</b> be published as part of the released model.
                We will store and process your contribution in an <b>anonymized</b> form and keep it confidential.
                <br><br>
                Your <b>email</b> and <b>organization</b> are collected only for submission tracking and potential follow-up;
                they are <b>not</b> used for model training and are not shared publicly.
            </p>
    </div>
  </div>
</section>

<script>
// Update API end point for presign and ssubmit
const API_BASE        = "https://71z3aqiv16.execute-api.us-east-1.amazonaws.com";
const PRESIGN_ENDPOINT = API_BASE + "/presign";
const SUBMIT_ENDPOINT  = API_BASE + "/submit";

const MAX_FILES = 10;
const MAX_TOTAL_BYTES = 10 * 1024 * 1024;
const ALLOWED_EXT = new Set(["wav","mp3"]);

function makeId() {
  const d = new Date();
  const rand = Math.random().toString(16).slice(2,8).toUpperCase();
  return `FAU-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${rand}`;
}

const sid = makeId(); // used internally, not shown

/* ===== Dynamic sentence fields ===== */
const container = document.getElementById("sentenceContainer");

function updateLabels() {
  container.querySelectorAll(".sentence-group").forEach((group, i) => {
    group.querySelector("label").textContent = `Sentence ${i + 1}`;
    let btn = group.querySelector(".remove-btn");
    if (i === 0) { btn?.remove(); return; }
    if (!btn) {
      btn = Object.assign(document.createElement("button"),
        {type:"button", className:"remove-btn", textContent:"×"});
      btn.addEventListener("click", () => { group.remove(); updateLabels(); });
      group.appendChild(btn);
    }
  });
}

document.getElementById("addSentenceBtn").addEventListener("click", () => {
  const wrapper = document.createElement("div");
  wrapper.className = "sentence-group";
  wrapper.innerHTML = `<label>Sentence</label><input type="text" class="sentence-input">`;
  container.appendChild(wrapper);
  updateLabels();
});

updateLabels();

/* ===== Collect form data ===== */
function collectFormData() {
  const email      = document.getElementById("email").value.trim();
  const occupation = document.getElementById("occupation").value;
  const university = document.getElementById("university").value.trim();
  // const consent    = document.getElementById("consent").value;

  if (!email || !occupation || !university) {
    alert("Please complete all required fields"); return null;
  }

  const sentences = [...document.querySelectorAll(".sentence-input")]
    .map(i => i.value.trim()).filter(Boolean);

  return { submission_id: sid, email, occupation, university,
           sentences, timestamp: new Date().toISOString() };
}

/* ===== File size hint ===== */
const audioInput = document.getElementById("audioFiles");
const sizeHint   = document.getElementById("sizeHint");

audioInput.addEventListener("change", () => {
  const files = [...audioInput.files];
  const total = files.reduce((s, f) => s + f.size, 0);
  sizeHint.textContent = files.length
    ? `Selected: ${files.length} file(s), ${(total/1024/1024).toFixed(2)} MB / 10 MB` : "";
});

/* ===== Upload ===== */
document.getElementById("uploadBtn").addEventListener("click", async () => {
  const status = document.getElementById("uploadStatus");
  const btn    = document.getElementById("uploadBtn");
  status.textContent = "";

  const data  = collectFormData(); if (!data) return;
  const files = [...audioInput.files];
  if (!files.length)             { alert("Please select audio files."); return; }
  if (files.length > MAX_FILES)  { alert("Max 10 files.");              return; }

  const total = files.reduce((s, f) => s + f.size, 0);
  if (total > MAX_TOTAL_BYTES)   { alert("Total size must be ≤ 10 MB."); return; }

  let descriptors;
  try {
    descriptors = files.map(f => {
      const ext = f.name.split(".").pop().toLowerCase();
      if (!ALLOWED_EXT.has(ext)) throw new Error("Not allowed: " + f.name);
      return { ext, content_type: f.type || "application/octet-stream", size: f.size };
    });
  } catch (e) { alert(e.message); return; }

  btn.disabled = true;
  try {
    status.textContent = "Requesting upload permissions…";
    const r = await fetch(PRESIGN_ENDPOINT, {
      method: "POST", headers: {"content-type":"application/json"},
      body: JSON.stringify({ submission_id: sid, files: descriptors })
    });
    if (!r.ok) throw new Error(await r.text());
    const { presigns } = await r.json();

    const audio_keys = [];
    for (let i = 0; i < files.length; i++) {
      status.textContent = `Uploading ${i+1}/${files.length}…`;
      const { key, upload } = presigns[i];
      const fd = new FormData();
      Object.entries(upload.fields).forEach(([k,v]) => fd.append(k, v));
      fd.append("file", files[i]);
      const up = await fetch(upload.url, { method: "POST", body: fd });
      if (!up.ok) throw new Error(`Upload failed for file ${i+1}`);
      audio_keys.push(key);
    }

    // status.textContent = "Saving metadata…";
    const s = await fetch(SUBMIT_ENDPOINT, {
      method: "POST", headers: {"content-type":"application/json"},
      body: JSON.stringify({ ...data, audio_keys })
    });
    if (!s.ok) throw new Error(await s.text());

    status.textContent = "Thank you for your submission!";
  } catch (e) {
    console.error(e);
    status.textContent = "Failed ❌ " + (e?.message ?? e);
  } finally {
    btn.disabled = false;
  }
});
</script>

</body>
</html>
